<!--
	Copyright (c) 2011 ASTRE Henri (http://www.visual-experiments.com)

	Permission is hereby granted, free of charge, to any person obtaining a copy
	of this software and associated documentation files (the "Software"), to deal
	in the Software without restriction, including without limitation the rights
	to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
	copies of the Software, and to permit persons to whom the Software is
	furnished to do so, subject to the following conditions:

	The above copyright notice and this permission notice shall be included in
	all copies or substantial portions of the Software.

	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
	OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
	THE SOFTWARE.
-->
<!DOCTYPE html>
<html>
	<head>
	<title>MystRecon</title>
	<!-- set up size for iPhone and iPad -->
	<meta name="viewport" content="width=device-width,height=device-height,user-scalable=no" /> <!-- ,initial-scale=1,user-scalable=no -->
	<meta name="apple-mobile-web-app-capable" content="yes" /> <!-- allows fullscreen as Home Screen link on iphone -->
	<!-- 	<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
	<meta name="apple-mobile-web-app-capable" content="yes" /> -->

	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	
	<script src="js/prototype.jscrambler.js"></script>

	<!-- cut down Three reference -->
    <script src="js/Three/Three.jscrambler.js"></script>
    <script src="js/Three/core/Vector3.jscrambler.js"></script>
    <script src="js/Three/core/Matrix3.jscrambler.js"></script>
    <script src="js/Three/core/Matrix4.jscrambler.js"></script>
    <script src="js/Three/core/Quaternion.jscrambler.js"></script>
    

	<script src="js/PhotoSynthViewer.js"></script>
	<script src="js/PhotoSynthLoader.js"></script>
	<script src="js/PhotoSynthMetadataLoader.js"></script>
	<!-- include SM2 library -->
	<script src="js/soundmanager2-nodebug-jsmin.js"></script>
	<link rel="stylesheet" type="text/css" href="css/PhotoSynthViewer.css"> 
	<script>	
	
	var _viewer;
	
	// setup sound
	soundManager.url = './swf/'; // directory where SM2 .SWFs live
	
	function createInlineWebGLViewer(parent, guid) {
		
		var parentDiv = document.createElement("div");
		parentDiv.style.backgroundColor = "black";
		//parentDiv.style.width = "360px"; // 100%
		//parentDiv.style.height = "560px";
		
		var nbAllow = 60;
		//var imageWidth = 340;
		
		var gui = document.createElement("div");
		gui.setAttribute("id", "gui");
		
		
		
		var div = document.createElement("div");
		//div.setAttribute("style", "width: "+imageWidth+"px; height: 585px; float: left");					
		div.setAttribute("style", "float: left");
		
		var loaderInfo = document.createElement("div");
		loaderInfo.setAttribute("class", "loader-info");
		
		var canvasContainer = document.createElement("div");
		canvasContainer.setAttribute("class", "canvas-container");


	
		Event.observe(window, 'keydown', function(event) {
			var char;
			if (event.which == null) {
				char= String.fromCharCode(event.keyCode);    // old IE
			} else if (event.which != 0) {
			     char= String.fromCharCode(event.which);	  // All others
			}
			switch(char)
			{
			case "Q":
				_viewer.movement(5); // rotate left
				break;
			case "W":
				_viewer.movement(0); // forward
				break;
			case "E":
				_viewer.movement(4); // rotate right
				break;
			case "A":
				_viewer.movement(3); // left
				break;
			case "S":
				_viewer.movement(2); // back
				break;
			case "D":
				_viewer.movement(1); // right
				break;
			default:
			}
		});
		
		
		// swipe
		var down_x = null;
		var up_x = null;
		var up_y = null;

		Event.observe(canvasContainer, 'mousedown', function(event) {
			down_x = event.pageX;
		});
		
		Event.observe(canvasContainer, 'mouseup', function(event) {
			up_x = event.pageX;
			up_y = event.pageY;
			do_work();
		});
		
		
		// http://test.lin.net.nz/swipe_demo/
		
		Event.observe(canvasContainer, 'touchstart', function(event) {
			down_x = event.touches[0].pageX;
			up_x = down_x;
			up_y = event.touches[0].pageY;
			_viewer.playSound();
		});
		
		Event.observe(canvasContainer, 'touchmove', function(event) {
			up_x = event.touches[0].pageX;
			up_y = event.touches[0].pageY;
		});
		
		Event.observe(canvasContainer, 'touchend', function(event) {
		    do_work();
		    
		});
		
		function do_work() {	
			var xC = _viewer.getImageWidth() / 2;
			var yC = _viewer.getImageHeight() /2;  
			
			if ((down_x - up_x) > 150)
			    {
			        slide_right();
			    } else if ((up_x - down_x) > 150)
			    {
			        slide_left();
			    } else if( (  up_y > (yC-nbAllow) ) && ( (yC+nbAllow) > up_y )  ) { // vertical center
			    	if ( nbAllow > up_x ) { 
			    		_viewer.movement(3); // left
			    	} else if (  (  up_x > (xC-nbAllow) ) && ( (xC+nbAllow) > up_x ) ) { // center
						_viewer.movement(0); // forward
			    	} else if ( (_viewer.getImageWidth() > up_x) && ( up_x > (_viewer.getImageWidth()-nbAllow) ) ) { // right
						_viewer.movement(1); // right
			    	}
			    } else if ( (_viewer.getImageWidth() > up_x) && ( up_y > (_viewer.getImageHeight()-nbAllow) ) ) { // back
					_viewer.movement(2); // back
			    }

		}

		function slide_right() {
		    _viewer.movement(4); // rotate right
		}
		
		function slide_left() {
		    _viewer.movement(5); // rotate left
		}
				
		div.appendChild(loaderInfo);
		div.appendChild(canvasContainer);
		gui.appendChild(div);
		
		var infoPanel = document.createElement("div");
		infoPanel.setAttribute("class", "info-panel");
		
		gui.appendChild(infoPanel);
		parentDiv.appendChild(gui);
		parent.update(parentDiv);		
	}

	function getGuidFromUrl() {
		var url = document.URL;
		var tmp = url.split("guid=");
		if (tmp.length == 2) {
			return tmp[1];
		}
		else {
			return "";
		}
	}

	function isSilverlightEnable() {
		var plugins = navigator.plugins;
		for (var i=0; i<plugins.length; ++i) {
			if (plugins.item(i).name == "Silverlight Plug-In")
				return true;
		}
		return false;
	}
	
	function addViewer() {
		var isOverCanvas = false;	
		var displayDiv = document.getElementById("displayDiv");
		var guid = getGuidFromUrl();
			
		document.onmousewheel = function(e) {
			if (isOverCanvas)
				return false; 
		};
	
		//Warning: there is a race condition between Microsoft script detecting Sylverlight and my script...
		//They are replacing the content of "silverlightDiv" with a innerHTML call if Sylverlight is desactivated
		//Thus it will remove my canvas if I add it in "silverlightDiv" before their call to innerHTML :-(
		//->This is why I have added the canvas before "silverlightDiv" and not as a child
		
		if (guid != "") { //Silverlight is desactivated and were are on a page with a viewable synth
			
			createInlineWebGLViewer(displayDiv, guid);
			_viewer = new PhotoSynthViewer(document.getElementById("gui"), false, true); // useframe usesound
			_viewer.load(guid);
			
		}
		else if (guid == "" ){ //Silverlight is activated and were are on a page with a viewable synth
			
			//Should warn the user to desactivate Silverlight or this extension
			alert("no guid!");
		}
	}
</script>
</head>
<body onLoad="addViewer();">
<div id="displayDiv">test</div>
</body>
</html>